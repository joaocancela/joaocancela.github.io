<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2.ª Volta — Simulador de Transferências</title>
  <style>
    :root{
      --border:#ddd;
      --bg:#fafafa;
      --muted:#666;
      --a:#4c78a8;   /* Seguro */
      --b:#e45756;   /* Ventura */
    }
    body{ font-family: system-ui, Arial, sans-serif; margin: 16px; max-width: 1100px; }
    h1{ margin: 0 0 6px; font-size: 18px; }
    .small{ color: var(--muted); font-size: 13px; line-height: 1.35; margin-top: 6px; }
    .panel{
      margin-top: 12px;
      border: 1px solid var(--border);
      background: var(--bg);
      padding: 12px;
      border-radius: 10px;
    }
    .grid{
      display: grid;
      grid-template-columns: 1.15fr 1fr;
      gap: 10px;
      align-items: start;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    table{ width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td{ border: 1px solid var(--border); padding: 10px; vertical-align: top; }
    th{ background: #f6f6f6; text-align: left; font-size: 13px; }
    td{ font-size: 13px; }
    .num{ text-align: right; white-space: nowrap; }
    .name{ font-weight: 700; }
    .meta{ color: var(--muted); font-size: 12px; margin-top: 4px; }

    .controlTitle{ font-weight: 700; margin-bottom: 6px; }
    .rowControls{ display: grid; grid-template-columns: 1fr; gap: 10px; }

    /* Single slider bar (turnout) */
    .barWrap{ display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    input[type="range"]{ width: 100%; }
    .pctBox{
      width: 72px;
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: flex-end;
      white-space: nowrap;
    }
    .pctBox input{
      width: 52px;
      text-align: right;
      padding: 4px 6px;
      font-size: 13px;
    }

    /* Two-way segmented bar (Seguro vs Ventura) */
    .segbar{
      position: relative;
      height: 22px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #eee;
      touch-action: none;
      display: flex;
    }
    .segA{ background: var(--a); height: 100%; }
    .segB{ background: var(--b); height: 100%; }
    .handle{
      position: absolute;
      top: -6px;
      width: 16px;
      height: 34px;
      cursor: ew-resize;
      touch-action: none;
      transform: translateX(-8px);
      background: rgba(0,0,0,0);
    }
    .handle::after{
      content:"";
      position:absolute;
      left: 7px; top: 8px;
      width: 2px; height: 18px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.08);
      border-radius: 1px;
    }
    .legend{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-size: 12px; color: var(--muted);
      margin-top: 6px;
    }
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
    .dotA{ background: var(--a); }
    .dotB{ background: var(--b); }

    .sticky{
      position: sticky;
      bottom: 10px;
      margin-top: 14px;
      border: 1px solid var(--border);
      background: white;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    .winner{ font-weight: 800; }
    .bar2{ height: 14px; background:#e6e6e6; border-radius: 8px; overflow:hidden; margin-top:10px; border: 1px solid var(--border); }
    .seg2A{ background: var(--a); height: 100%; display:inline-block; }
    .seg2B{ background: var(--b); height: 100%; display:inline-block; }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    button{ font-size: 14px; padding: 8px 10px; }
  </style>
</head>
<body>
  <h1>2.ª Volta — Simulador de Transferências (AJS vs AV)</h1>
  <div class="small">
    Para cada grupo (definido pelo comportamento na 1.ª volta), indique:
    (i) que percentagem volta a votar na 2.ª volta; (ii) entre os que votam, a divisão entre António José Seguro e André Ventura.
    <br/>
    Nota: aqui assume-se que quem vota na 2.ª volta escolhe um dos dois (sem branco/nulos na simulação).
  </div>

  <div class="btns">
    <button id="resetBtn" type="button">Repor valores iniciais</button>
  </div>

  <div id="app"></div>

  <div class="sticky">
    <div id="summaryLine"></div>
    <div class="bar2" id="overallBar"></div>
    <div class="small" id="turnoutLine" style="margin-top:8px;"></div>
  </div>

<script>
/* ---------------------------
   INPUT: 1.ª volta (dados do utilizador)
--------------------------- */
const INSCRITOS = 11017202;
const VOTANTES_1V = 5767057;

const GROUPS = [
  { key:"ajs", name:"António José Seguro", votes:1754904 },
  { key:"av",  name:"André Ventura", votes:1326648 },
  { key:"jcf", name:"João Cotrim de Figueiredo", votes:902571 },
  { key:"hgm", name:"Henrique Gouveia e Melo", votes:695091 },
  { key:"lmm", name:"Luís Marques Mendes", votes:637394 },
  { key:"outros", name:"Outros", votes: 323842 }, // Catarina, AF, MJV, JP, APS, HC
  // Abstenção + branco + nulos (1.ª volta)
  { key:"abst", name:"Abstenção, branco e nulos", votes: (INSCRITOS - VOTANTES_1V) + 61226 + 65381 }
];

// Two finalists
const FINAL_A = { key:"AJS", label:"António José Seguro", color:"var(--a)" };
const FINAL_B = { key:"AV",  label:"André Ventura",       color:"var(--b)" };

/* ---------------------------
   DEFAULTS (ajustáveis)
   - Turnout: 100% para quem votou num candidato; 0% para abstenção/branco/nulos
   - Preferência: grupos AJS/AV começam 100% no próprio; restantes 50/50
--------------------------- */
let state = {}; // per group: { turnout: int 0..100, shareB: int 0..100 } where shareB is AV among voters; AJS = 100-shareB

function initDefaults(){
  state = {};
  for (const g of GROUPS){
    const votedCandidate = (g.key !== "abst");
    const turnout = votedCandidate ? 100 : 0;

    let shareB = 50; // AV
    if (g.key === "av")  shareB = 100;
    if (g.key === "ajs") shareB = 0;

    state[g.key] = { turnout, shareB };
  }
}

/* ---------------------------
   HELPERS
--------------------------- */
function el(tag, attrs={}, children=[]){
  const node = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (k === "class") node.className = v;
    else if (k === "html") node.innerHTML = v;
    else if (k === "text") node.textContent = v;
    else node.setAttribute(k, v);
  }
  for (const c of children) node.appendChild(c);
  return node;
}
function clampInt(x){
  if (Number.isNaN(x)) return 0;
  x = Math.round(x);
  return Math.max(0, Math.min(100, x));
}
function fmtInt(n){
  return n.toLocaleString("pt-PT");
}
function pct(x, d=1){
  return (x*100).toFixed(d) + "%";
}

/* ---------------------------
   COMPUTE
--------------------------- */
function computeSecondRound(){
  let votesA = 0; // AJS
  let votesB = 0; // AV
  let totalVoters2 = 0;

  for (const g of GROUPS){
    const turnout = state[g.key].turnout / 100;
    const shareB = state[g.key].shareB / 100;
    const shareA = 1 - shareB;

    const participating = g.votes * turnout;
    totalVoters2 += participating;

    votesA += participating * shareA;
    votesB += participating * shareB;
  }

  // normalize to valid shares among those who vote (should sum to 100)
  const totalValid = votesA + votesB;
  const shareA = totalValid > 0 ? votesA / totalValid : 0;
  const shareB = totalValid > 0 ? votesB / totalValid : 0;

  return { votesA, votesB, totalVoters2, totalValid, shareA, shareB };
}

function verdict(res){
  // threshold: 50%+1 pp => >=51.0%
  const aPct = res.shareA * 100;
  const bPct = res.shareB * 100;
  if (aPct >= 51.0){
    return { text: `Candidato ganha: <span class="winner">${FINAL_A.label}</span> (${aPct.toFixed(1)}%).`, winner:"A" };
  }
  if (bPct >= 51.0){
    return { text: `Candidato ganha: <span class="winner">${FINAL_B.label}</span> (${bPct.toFixed(1)}%).`, winner:"B" };
  }
  // If neither reaches 51, still a winner exists by >50; but user asked this rule explicitly.
  // We'll still state "sem maioria absoluta" and show who is ahead.
  const lead = (aPct >= bPct) ? FINAL_A.label : FINAL_B.label;
  const leadPct = Math.max(aPct, bPct).toFixed(1);
  return { text: `Sem maioria absoluta (50%+1pp). À frente: <span class="winner">${lead}</span> (${leadPct}%).`, winner:null };
}

/* ---------------------------
   UI: segmented preference bar (AJS vs AV)
   - one handle adjusting split; integer values
--------------------------- */
function attachPreferenceDrag(handle, groupKey){
  let dragging = false;
  let startX = 0;
  let startShareB = 0;
  let barWidth = 1;

  const onDown = (e) => {
    e.preventDefault();
    dragging = true;
    const bar = document.getElementById(`pref_bar_${groupKey}`);
    barWidth = Math.max(1, bar.getBoundingClientRect().width);
    startX = (e.touches ? e.touches[0].clientX : e.clientX);
    startShareB = state[groupKey].shareB;

    window.addEventListener("mousemove", onMove, { passive:false });
    window.addEventListener("mouseup", onUp, { passive:false });
    window.addEventListener("touchmove", onMove, { passive:false });
    window.addEventListener("touchend", onUp, { passive:false });
  };

  const onMove = (e) => {
    if (!dragging) return;
    e.preventDefault();
    const x = (e.touches ? e.touches[0].clientX : e.clientX);
    const dx = x - startX;
    const delta = Math.round((dx / barWidth) * 100); // + => more AV
    const newShareB = clampInt(startShareB + delta);

    state[groupKey].shareB = newShareB;
    refreshGroup(groupKey);
    refreshSummary();
  };

  const onUp = (e) => {
    if (!dragging) return;
    e.preventDefault();
    dragging = false;
    window.removeEventListener("mousemove", onMove);
    window.removeEventListener("mouseup", onUp);
    window.removeEventListener("touchmove", onMove);
    window.removeEventListener("touchend", onUp);
  };

  handle.addEventListener("mousedown", onDown, { passive:false });
  handle.addEventListener("touchstart", onDown, { passive:false });
}

/* ---------------------------
   RENDER
--------------------------- */
function render(){
  const app = document.getElementById("app");
  app.innerHTML = "";

  const table = el("table");
  const thead = el("thead");
  thead.appendChild(el("tr", {}, [
    el("th", { html:"Grupo (1.ª volta)" }),
    el("th", { class:"num", html:"Votos/Eleitores (base)" }),
    el("th", { class:"num", html:"% no total (base)" }),
    el("th", { html:"2.ª volta — participação" }),
    el("th", { html:"2.ª volta — escolha (AJS vs AV)" })
  ]));
  table.appendChild(thead);

  const tbody = el("tbody");
  for (const g of GROUPS){
    const baseShare = g.votes / INSCRITOS;

    const turnoutBox = el("div", { class:"barWrap" }, [
      el("input", {
        type:"range", min:"0", max:"100", step:"1",
        id:`turn_${g.key}`,
        value: String(state[g.key].turnout)
      }),
      el("div", { class:"pctBox" }, [
        el("input", { type:"number", min:"0", max:"100", step:"1", inputmode:"numeric", id:`turn_num_${g.key}` }),
        el("span", { text:"%" })
      ])
    ]);

    const prefWrap = el("div", {}, []);
    const segbar = el("div", { class:"segbar", id:`pref_bar_${g.key}` }, [
      el("div", { class:"segA", id:`segA_${g.key}` }),
      el("div", { class:"segB", id:`segB_${g.key}` }),
      el("div", { class:"handle", id:`handle_${g.key}` })
    ]);
    const legend = el("div", { class:"legend" }, [
      el("span", { html:`<span class="dot dotA"></span>${FINAL_A.label}` }),
      el("span", { html:`<span class="dot dotB"></span>${FINAL_B.label}` })
    ]);

    const prefNums = el("div", { class:"barWrap", style:"margin-top:8px;" }, [
      el("div", { style:"width:100%;" , class:"small", html:"(entre os que votam na 2.ª volta)" }),
      el("div", { class:"pctBox" }, [
        el("input", { type:"number", min:"0", max:"100", step:"1", inputmode:"numeric", id:`b_num_${g.key}` }),
        el("span", { text:"% AV" })
      ])
    ]);

    prefWrap.appendChild(segbar);
    prefWrap.appendChild(legend);
    prefWrap.appendChild(prefNums);

    const tr = el("tr", { id:`row_${g.key}` }, [
      el("td", {}, [
        el("div", { class:"name", text:g.name }),
        el("div", { class:"meta", text:`Base: ${fmtInt(g.votes)} eleitores` })
      ]),
      el("td", { class:"num", text: fmtInt(g.votes) }),
      el("td", { class:"num", text: (baseShare*100).toFixed(2) + "%" }),
      el("td", {}, [turnoutBox]),
      el("td", {}, [prefWrap])
    ]);

    tbody.appendChild(tr);

    // wiring
    const turn = turnoutBox.querySelector(`#turn_${g.key}`);
    const turnNum = turnoutBox.querySelector(`#turn_num_${g.key}`);
    turnNum.value = String(state[g.key].turnout);

    turn.addEventListener("input", () => {
      state[g.key].turnout = clampInt(parseFloat(turn.value));
      turnNum.value = String(state[g.key].turnout);
      refreshSummary();
    });
    const commitTurnNum = () => {
      state[g.key].turnout = clampInt(parseFloat(turnNum.value));
      turn.value = String(state[g.key].turnout);
      turnNum.value = String(state[g.key].turnout);
      refreshSummary();
    };
    turnNum.addEventListener("change", commitTurnNum);
    turnNum.addEventListener("blur", commitTurnNum);

    // preference numeric (AV %)
    const bNum = prefWrap.querySelector(`#b_num_${g.key}`);
    bNum.value = String(state[g.key].shareB);
    const commitBNum = () => {
      state[g.key].shareB = clampInt(parseFloat(bNum.value));
      bNum.value = String(state[g.key].shareB);
      refreshGroup(g.key);
      refreshSummary();
    };
    bNum.addEventListener("change", commitBNum);
    bNum.addEventListener("blur", commitBNum);

    // drag handle
    const handle = prefWrap.querySelector(`#handle_${g.key}`);
    attachPreferenceDrag(handle, g.key);
  }

  table.appendChild(tbody);
  app.appendChild(table);

  refreshAllGroups();
  refreshSummary();
}

function refreshGroup(groupKey){
  const shareB = state[groupKey].shareB;     // AV
  const shareA = 100 - shareB;              // AJS

  const segA = document.getElementById(`segA_${groupKey}`);
  const segB = document.getElementById(`segB_${groupKey}`);
  if (segA && segB){
    segA.style.width = `${shareA}%`;
    segB.style.width = `${shareB}%`;
  }

  const bar = document.getElementById(`pref_bar_${groupKey}`);
  const handle = document.getElementById(`handle_${groupKey}`);
  if (bar && handle){
    const w = bar.getBoundingClientRect().width;
    // handle at boundary after AJS segment
    const x = (w * shareA / 100);
    handle.style.left = `${x}px`;
  }

  const bNum = document.getElementById(`b_num_${groupKey}`);
  if (bNum && document.activeElement !== bNum){
    bNum.value = String(shareB);
  }
}

function refreshAllGroups(){
  for (const g of GROUPS) refreshGroup(g.key);
}

function refreshSummary(){
  const res = computeSecondRound();
  const v = verdict(res);

  const aPct = res.shareA * 100;
  const bPct = res.shareB * 100;

  const summaryLine = document.getElementById("summaryLine");
  summaryLine.innerHTML =
    `${v.text} &nbsp;|&nbsp; ` +
    `${FINAL_A.label}: <strong>${aPct.toFixed(1)}%</strong> (${fmtInt(Math.round(res.votesA))} votos) · ` +
    `${FINAL_B.label}: <strong>${bPct.toFixed(1)}%</strong> (${fmtInt(Math.round(res.votesB))} votos)`;

  const overallBar = document.getElementById("overallBar");
  overallBar.innerHTML = "";
  const segA = el("span", { class:"seg2A", style:`width:${aPct.toFixed(4)}%` });
  const segB = el("span", { class:"seg2B", style:`width:${bPct.toFixed(4)}%` });
  overallBar.appendChild(segA);
  overallBar.appendChild(segB);

  const turnoutLine = document.getElementById("turnoutLine");
  const turnoutPctInscritos = INSCRITOS > 0 ? (res.totalVoters2 / INSCRITOS) : 0;
  turnoutLine.innerHTML =
    `Participação simulada (2.ª volta): <strong>${fmtInt(Math.round(res.totalVoters2))}</strong> eleitores ` +
    `(${(turnoutPctInscritos*100).toFixed(1)}% dos inscritos).`;
}

/* ---------------------------
   BOOT
--------------------------- */
document.getElementById("resetBtn").addEventListener("click", () => {
  initDefaults();
  render();
});

initDefaults();
render();
</script>
</body>
</html>
