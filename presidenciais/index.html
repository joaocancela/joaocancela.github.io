<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulador de Voto por Demografia (MVP)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; max-width: 1100px; }
    h1 { margin: 0 0 10px; font-size: 20px; }
    .small { color: #555; font-size: 13px; margin-top: 6px; }
    table { border-collapse: collapse; width: 100%; margin-top: 14px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: middle; }
    th { background: #f6f6f6; text-align: left; }
    td.num { width: 92px; white-space: nowrap; }
    input { font-size: 14px; padding: 6px 8px; width: 88px; }
    button { font-size: 14px; padding: 6px 10px; }

    .result { margin-top: 14px; padding: 12px; border: 1px solid #ddd; background: #fafafa; }
    .barwrap { margin-top: 10px; }
    .bar { height: 14px; background: #e6e6e6; border-radius: 8px; overflow: hidden; }
    .seg { height: 100%; display: inline-block; }

    .errorbox { margin-top: 12px; padding: 10px 12px; border: 1px solid #b00020; background: #fff5f6; color: #8b0018; }
    .rowbad { background: #fff5f6; }
    .sumok { color: #1b5e20; font-weight: 600; }
    .sumbad { color: #b00020; font-weight: 700; }

    /* simple, distinct segment colors without extra deps */
    .c0 { background: #4c78a8; }
    .c1 { background: #f58518; }
    .c2 { background: #54a24b; }
    .c3 { background: #e45756; }
    .c4 { background: #72b7b2; }
    .c5 { background: #bdbdbd; }
  </style>
</head>
<body>
  <h1>Simulador de Voto por Demografia (MVP)</h1>

  <div class="small">
    Preencha percentagens por cada um dos 8 grupos (idade × género × escolaridade). Cada linha tem de somar 100%.
  </div>

  <div style="margin-top:10px;">
    <button id="resetBtn" type="button">Repor (valores iguais por candidato)</button>
  </div>

  <div id="app"></div>

  <div id="validation" class="errorbox" style="display:none;"></div>

  <div class="result">
    <strong>Resultado global implícito (ponderado):</strong>
    <div id="overallText" style="margin-top:8px;"></div>

    <div class="barwrap">
      <div class="bar" id="overallBar"></div>
    </div>

    <div class="small" style="margin-top:10px;">
      Método: resultado global = Σ (peso do grupo × percentagem atribuída no grupo). Sem normalização automática.
    </div>
  </div>

<script>
/**
 * CONFIG: 6 opções (5 nomes aleatorizados + "Outros" sempre no fim).
 * "Outros" corresponde ao agregado (Catarina Martins + Jorge Pinto + António Filipe).
 */
const FIXED_LAST = { key: "outros", label: "Outros" };
const CANDIDATES_BASE = [
  { key: "av", label: "André Ventura" },
  { key: "jcf", label: "João Cotrim de Figueiredo" },
  { key: "hgm", label: "Henrique Gouveia e Melo" },
  { key: "ajs", label: "António José Seguro" },
  { key: "lmm", label: "Luís Marques Mendes" }
];

// Fisher–Yates shuffle
function shuffle(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

const CANDIDATES = [...shuffle(CANDIDATES_BASE), FIXED_LAST];

/**
 * CONFIG: 8 células na ordem pedida:
 * Idade (<55, 55+) → Género (Homem, Mulher) → Escolaridade (Não pós-secundário, Ensino Pós-Secundário)
 *
 * Pesos (%): os teus valores (com ESCOLARIEDADE==99 removido e renormalizado).
 */
const CELLS = [
  // <55
  { id:"u55_h_nps", age:"<55", gender:"Homem",  edu:"Não pós-secundário",     w:16.9533 },
  { id:"u55_h_ps",  age:"<55", gender:"Homem",  edu:"Ensino Pós-Secundário",  w:12.13539 },
  { id:"u55_m_nps", age:"<55", gender:"Mulher", edu:"Não pós-secundário",     w:14.80357 },
  { id:"u55_m_ps",  age:"<55", gender:"Mulher", edu:"Ensino Pós-Secundário",  w:16.89007 },

  // 55+
  { id:"55p_h_nps", age:"55+", gender:"Homem",  edu:"Não pós-secundário",     w:15.49064 },
  { id:"55p_h_ps",  age:"55+", gender:"Homem",  edu:"Ensino Pós-Secundário",  w: 4.35424 },
  { id:"55p_m_nps", age:"55+", gender:"Mulher", edu:"Não pós-secundário",     w:14.30619 },
  { id:"55p_m_ps",  age:"55+", gender:"Mulher", edu:"Ensino Pós-Secundário",  w: 5.066599 },
];

// Hard constraint tolerance for row sum (because inputs are decimals)
const SUM_TOL = 0.05; // accepts 99.95..100.05

// State: per cell, candidate shares in %
let state = {}; // { [cellId]: { [candidateKey]: number } }

function initStateEqual() {
  state = {};
  const equal = 100 / CANDIDATES.length;
  for (const cell of CELLS) {
    state[cell.id] = {};
    for (const c of CANDIDATES) state[cell.id][c.key] = equal;
  }
}

function el(tag, attrs={}, children=[]) {
  const node = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === "class") node.className = v;
    else if (k === "html") node.innerHTML = v;
    else node.setAttribute(k, v);
  }
  for (const c of children) node.appendChild(c);
  return node;
}

function fmtPct(x, d=2) { return `${x.toFixed(d)}%`; }

function rowSum(cellId) {
  let s = 0;
  for (const c of CANDIDATES) s += (state[cellId][c.key] ?? 0);
  return s;
}

function allRowsValid() {
  for (const cell of CELLS) {
    const s = rowSum(cell.id);
    if (Math.abs(100 - s) > SUM_TOL) return false;
  }
  return true;
}

function renderTable() {
  const app = document.getElementById("app");
  app.innerHTML = "";

  const table = el("table");
  const thead = el("thead");
  const trh = el("tr");

  trh.appendChild(el("th", { html: "Idade" }));
  trh.appendChild(el("th", { html: "Género" }));
  trh.appendChild(el("th", { html: "Escolaridade" }));
  trh.appendChild(el("th", { html: "Peso" }));

  for (const c of CANDIDATES) trh.appendChild(el("th", { html: `${c.label} (%)` }));
  trh.appendChild(el("th", { html: "Soma" }));

  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = el("tbody");

  CELLS.forEach((cell) => {
    const tr = el("tr", { id: `row_${cell.id}` });

    tr.appendChild(el("td", { html: cell.age }));
    tr.appendChild(el("td", { html: cell.gender }));
    tr.appendChild(el("td", { html: cell.edu }));
    tr.appendChild(el("td", { class: "num", html: fmtPct(cell.w, 2) }));

    CANDIDATES.forEach((cand) => {
      const input = el("input", {
        type: "number",
        min: "0",
        max: "100",
        step: "0.1",
        value: (state[cell.id][cand.key] ?? 0).toFixed(1)
      });

      input.addEventListener("input", () => {
        let v = parseFloat(input.value);
        if (Number.isNaN(v)) v = 0;
        v = Math.max(0, Math.min(100, v));
        state[cell.id][cand.key] = v;
        update();
      });

      const td = el("td");
      td.appendChild(input);
      tr.appendChild(td);
    });

    tr.appendChild(el("td", { class:"num", id:`sum_${cell.id}` }));
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  app.appendChild(table);

  app.appendChild(el("div", { class:"small", html: "Nota: “Ensino Pós-Secundário” = Bacharelato/Ensino Médio ou Licenciatura+ (categorias 6 ou 7). “Não quer responder” foi excluído dos pesos." }));
}

function computeOverall() {
  // assumes rows are valid; otherwise returns null
  if (!allRowsValid()) return null;

  const overall = {};
  for (const c of CANDIDATES) overall[c.key] = 0;

  for (const cell of CELLS) {
    const w = cell.w / 100.0;
    for (const cand of CANDIDATES) {
      overall[cand.key] += w * (state[cell.id][cand.key] / 100.0);
    }
  }
  return overall; // proportions summing to 1
}

function updateRowSumsAndHighlight() {
  let badRows = [];
  for (const cell of CELLS) {
    const s = rowSum(cell.id);
    const sumEl = document.getElementById(`sum_${cell.id}`);
    const rowEl = document.getElementById(`row_${cell.id}`);

    const ok = Math.abs(100 - s) <= SUM_TOL;
    if (sumEl) {
      sumEl.textContent = s.toFixed(1) + "%";
      sumEl.className = "num " + (ok ? "sumok" : "sumbad");
    }
    if (rowEl) {
      rowEl.classList.toggle("rowbad", !ok);
    }
    if (!ok) badRows.push({ cell, sum: s });
  }

  const validation = document.getElementById("validation");
  if (badRows.length > 0) {
    validation.style.display = "block";
    const items = badRows.map(r =>
      `<li><strong>${r.cell.age}</strong> · ${r.cell.gender} · ${r.cell.edu}: soma = ${r.sum.toFixed(1)}%</li>`
    ).join("");
    validation.innerHTML = `
      <div><strong>Corrigir antes de ver o resultado global:</strong> cada linha tem de somar 100%.</div>
      <ul style="margin:8px 0 0 20px;">${items}</ul>
    `;
  } else {
    validation.style.display = "none";
    validation.innerHTML = "";
  }
}

function renderOverall(overall) {
  const overallText = document.getElementById("overallText");
  const overallBar = document.getElementById("overallBar");

  if (!overall) {
    overallText.textContent = "—";
    overallBar.innerHTML = "";
    return;
  }

  // text
  const parts = CANDIDATES.map((c) => `${c.label}: ${(overall[c.key]*100).toFixed(1)}%`);
  overallText.textContent = parts.join(" • ");

  // bar
  overallBar.innerHTML = "";
  CANDIDATES.forEach((c, idx) => {
    const seg = el("span", { class: `seg c${idx}`, style: `width:${(overall[c.key]*100).toFixed(4)}%` });
    overallBar.appendChild(seg);
  });
}

function update() {
  updateRowSumsAndHighlight();
  const overall = computeOverall();
  renderOverall(overall);
}

document.getElementById("resetBtn").addEventListener("click", () => {
  initStateEqual();
  renderTable();
  update();
});

// boot
initStateEqual();
renderTable();
update();
</script>
</body>
</html>
